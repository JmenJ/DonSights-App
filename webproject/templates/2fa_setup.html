{% extends "base.html" %}
{% block content %}
<div class="cont2fa">
  <h1>Настройка двухфакторной аутентификации (2FA)</h1>

  {% if checking %}
    <!-- Режим проверки при логине -->
    <p>Введите код из приложения (Google Authenticator / Authy) для завершения входа.</p>
    {% if error %}
      <p class="error">{{ error }}</p>
    {% endif %}
    <form method="post" action="/2fa_check">
      <label for="code">Код:</label>
      <input id="code" name="code" type="text" pattern="\d{6}" required autofocus placeholder="6 цифр">
      <div class="form-actions">
        <button type="submit" class="button">Продолжить</button>
        <a href="/login" class="cancel-link">Отмена</a>
      </div>
    </form>
  {% else %}
    <!-- Настройка 2FA -->
    <div class="status-section">
      <div class="status-text">
        <p><strong>Текущий статус:</strong></p>
        {% if user.is_2fa_enabled %}
          <p class="enabled">Включена ✅</p>
        {% else %}
          <p class="disabled">Выключена — рекомендуется включить для безопасности</p>
        {% endif %}
      </div>

      <div class="status-action">
        {% if user.is_2fa_enabled %}
          <form method="post" action="/user/{{ user.id }}/2fa_disable">
            <button type="submit" class="button red">Отключить 2FA</button>
          </form>
        {% else %}
          <button id="showSetupBtn" type="button" class="button green">Включить 2FA</button>
        {% endif %}
      </div>
    </div>

    {% if not user.is_2fa_enabled %}
    <div id="setupBlock" class="setup-block">
      <h3>Настройка 2FA</h3>
      <p>Отсканируйте QR-код в приложении Google Authenticator (или любом другом TOTP-клиенте). Если не получается — вручную введите ключ.</p>

      <div class="setup-content">
        <div class="qr-block">
          {% if qr %}
            <img src="data:image/png;base64,{{ qr }}" alt="QR code">
          {% else %}
            <div class="qr-placeholder">QR отсутствует</div>
          {% endif %}
        </div>

        <div class="secret-block">
          <p><strong>Секретный ключ</strong></p>
          <div class="copy-wrapper">
            <code>{{ secret }}</code>
            <button id="copySecretBtn" type="button">Копировать</button>
          </div>

          <p class="info-text">После добавления аккаунта в приложение введите текущий одноразовый код ниже:</p>
          {% if error %}
            <p class="error">{{ error }}</p>
          {% endif %}

          <form method="post" action="/user/{{ user.id }}/2fa_enable">
            <label for="code_enable">Код из приложения:</label>
            <input id="code_enable" name="code" type="text" pattern="\d{6}" required placeholder="6 цифр" autofocus>
            <div class="form-actions">
              <button type="submit" class="button green">Подтвердить и включить 2FA</button>
              <a href="/user/{{ user.id }}" class="cancel-link">Отмена</a>
            </div>
          </form>
        </div>
      </div>
    </div>
    {% endif %}
  {% endif %}
</div>

<script>
  (function(){
    const showBtn = document.getElementById('showSetupBtn');
    const setup = document.getElementById('setupBlock');
    if (showBtn && setup) {
      showBtn.addEventListener('click', () => {
        setup.style.display = 'block';
        setup.scrollIntoView({behavior: 'smooth', block: 'center'});
      });
    }

    const copyBtn = document.getElementById('copySecretBtn');
    if (copyBtn) {
      copyBtn.addEventListener('click', async () => {
        const secretEl = document.querySelector('code');
        if (!secretEl) return;
        const text = secretEl.textContent.trim();
        try {
          await navigator.clipboard.writeText(text);
          copyBtn.textContent = 'Скопировано';
          setTimeout(()=> copyBtn.textContent = 'Копировать', 1500);
        } catch (e) {
          alert('Не удалось скопировать автоматически. Скопируйте вручную: ' + text);
        }
      });
    }
  })();
</script>
{% endblock %}
